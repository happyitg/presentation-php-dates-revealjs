<!doctype html>
<html lang="fr">

	<head>
		<meta charset="utf-8">

		<title>La génération des dates en PHP: Slides</title>

		<meta name="description" content="La génération des dates en PHP: Slides">
		<meta name="author" content="Kevin Nadin">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/sky-new.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
		<style>
			table.topics td {
				font-size: 0.7em;
			}
			table.topics td+td {
				text-align: center;
			}
			table.topics td+td i.fa-thumbs-o-up {
				color: green;
			}
			table.topics td+td i.fa-thumbs-o-down {
				color: red;
			}
		</style>
		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">
			<div class="slides">
				<section>
					<h1>La génération de dates en PHP</h1>
					
					<p>
						Par Kevin Nadin, conférencier Padawan / <a href="https://twitter.com/kevinjhappy">@kevinjhappy</a> - Forum PHP 2017
					</p>
				</section>

				<section>
					<section>
						<h2>Vraiment ??</h2>
						
						<h2>Une présentation sur les dates ??</h2>
						<p>
							<ul>
								<li>Oui, les dates sont piégeuses!</li>
								<li>Il y a beaucoup de possibilités de les générer, et elles peuvent vous causer des soucis...</li>
							</ul>
						</p>
					</section>
					<section>
						<h2>Nous allons voir de suite :</h2>
						<ol>
							<li>La fonction date() (forcément)</li>
							<li>les fonctions de timestamp: mktime, strtotime</li>
							<li>L'objet DateTime</li>
							<li>L'objet DateTimeZone</li>
							<li>L'objet DateInterval</li>
						</ol>
					</section>
				</section>
				<section>
					<section>
						<h1>La fonction date()</h1>
					</section>
					<section>
						<h2>Commencons avec les bases :</h2>
						<ul>
							<li>La première fonction à laquelle on pense, évidemment</li>
							<li>Elle l'a été pour moi pour en générer</li>
							<li>php.net: fonction date</li>
						</ul>
					</section>
					<section>
						<pre><code class="php">$testDate = date('Y-m-d');

echo $testDate; 

// 2017-05-26


$testDate = date('Y-m-d H:i:s');

echo $testDate; 

// 2017-05-26 16:25:08

</code></pre>
					</section>
					<section>
						<h2>Les dates avec un timestamp</h2>
						<p>date() accepte un timestamp comme second paramètre</p>
						<pre><code class="php">string date ( string $format [, int $timestamp = time() ] )</code></pre>
					</section>
					<section>
						<h2>Timestamps ??</h2>
						<p>Un timestamp est le nombre de secondes écoulée depuis le 1er Janvier 1970</p>
						<p>Aucune décalage horaire n'est appliqué à ce calcul</p>
					</section>
				</section>
				<section>
					<section>
						<h1>
							fonction mktime()
						</h1>
					</section>
					<section>
						<p>Prends en entrée 6 paramètres :</p>
						<p>ATTENTION A LEUR ORDRES !</p>
						<ul>
							<li>1- heures</li>
							<li>2- minutes</li>
							<li>3- secondes</li>
							<li>4- mois</li>
							<li>5- jours</li>
							<li>6- années</li>
						</ul> 
					</section>
					<section>
						<pre><code class="php">$hour = 0 ;
$minute = 0 ;
$second = 0 ;
$month = 10 ;
$day = 24 ;
$year = 2016 ;

$timestamp = mktime($hour, $minute, $second, $month, $day, $year);

$myDate = date('Y-m-d', $timestamp);

echo $myDate; // 2016-10-24</code></pre>
					</section>
					<section>
						<h2>mktime semble un peu moisie...</h2>
						<p>Ouais c'est vrai, cela peut être très compliqué.</p>
						<p>Mais cela peut apporter une précision chirurgicale</p>
					</section>
					<section>
						<pre width="800"><code class="php">// I want to get the last day of last month, we are the 26th May 2017

$month = date('m')-1 ;
$year = date('Y') ;

// get the timestamp of last month
$timestampLastMonth = mktime(0, 0, 0, $month, 1, $year) ;

// get the last day of the month, so the 30th April
$lastDayOfTheMonth = date('t', $timestampLastMonth);

$timestampLastDayOfLastMonth = mktime(0, 0, 0, $month, $lastDayOfTheMonth, $year);

// I have the correct timestamp, I can call the function date
$lastDayOfLastMonth = date('Y-m-d', $timestampLastDayOfLastMonth);

echo $lastDayOfLastMonth; // 2017-04-30
</code></pre>
					</section>
					<section><img src="images/I-smile-because-i-have-no-idea-whats-going-on.jpg" alt="I smile because I have no idea whats going on">
					</section>
					<section><pre class="stretch"><code class="php">//  I want to get the last day of last month, we are the 26th May 2017
// made in one line 

$lastDayOfLastMonth = date(
    'Y-m-d', 
    mktime( 
        0, 
        0, 
        0, 
        date('m')-1, 
        date('t', mktime(
			0,
			0,
			0,
			date('m')-1,
			1,
			date('Y')
			)),
        date('Y')
    )
);
// => 2017-04-30</code></pre></section>
					<section><img src="images/Not-sure-if-its-php-or-matrix-source-code.jpg" alt="Not sure if its php or matrix source code">
					</section>
					<section>
						<h2>Comportement à connaitre</h2>
						<p>Si j'essaye de mettre le 33 Janvier</p>
						<pre><code class="php">echo date('Y-m-d', mktime(0, 0, 0, 1, 33, 2017));

// 2017-02-02</code></pre>
<p>Cela va prendre la date du 31 Janvier + 2 jours</p>
					</section>
					<section><img src="images/why-it-doesnt-send-me-a-fatal-error.jpg" alt="why-it-doesnt-send-me-a-fatal-error">
					</section>
				</section>
				<section>
					<section>
						<h2><code>strtotime</code>(<code>string $time</code>, <code>int $timestamp</code>)</h2>
					</section>
					<section>
						<p>Supposons, nous somme le 2017-05-26 :</p>
						<pre class="fragment" ><code class="php">$firstDayOfLastMonth = date('Y-m-d', strtotime("first day of last month"));

// => 2017-04-01</code></pre>
						<pre class="fragment" ><code class="php">$lastDayOfLastMonth = date('Y-m-d', strtotime("last Day of Last Month"));

// => 2017-04-30</code></pre>
						<pre class="fragment" ><code class="php">$lastSunday = date('Y-m-d', strtotime("last Sunday"));

// => 2017-05-21</code></pre>
						<pre class="fragment" ><code class="php">$mondayOfLastWeek = date('Y-m-d', strtotime("last Monday of Last Week"));

// => 2017-05-15</code></pre>
					</section>
					<section>
						<h2>Alors strtotime est bien ?</h2>
						<p>Ouais, c'est pas mal du tout</p>
						<p>Mais il faut faire attention à la "magie" de la fonction</p>
						<p>Certaines dates ne peuvent pas être faite avec</p>
					</section>
					<section>
						<pre><code class="php">// WARNING !! first Specific day of last week
// will not give you what you want

$date = date('Y-m-d', strtotime("First Monday of Last Week"));

// => 2017-04-24</code></pre>
<pre class="fragment"><code class="php">// WARNING !! if you are the 31th, Last month will give you 
// the day one of this month

$timeThirtyOneOctober = mktime(0,0,0,10,31,2017);

$wrongDate = date('Y-m-d', strtotime("Last Month", $timeThirtyOneOctober));

// => 2017-10-01</code></pre>
<pre class="fragment"><code class="php">// Only way to get it right is by using this
$goodDate = date('Y-m-d', strtotime(
	"Last Day of Last Month", 
	$timeThirtyOneOctober
	));

// => 2017-09-30</code></pre>

					</section>
					<section>
						<img src="images/Jackie-Chan-WTF.jpg" alt="Jackie-Chan-WTF">
					</section>
					<section>
<pre><code class="php">// WARNING, some phrases seems Ok but does not work at all

$wrongDate = date('Y-m-d', strtotime("Monday of Last Week"));

// => 1970-01-01</code></pre>
<pre class="fragment"><code class="php">// You can't construct with strtotime the 13th of this month

$dayFifteenOfThisMonth = date(
	'Y-m-d',
	mktime(0, 0, 0, date('m'), 13, date('Y'))
);

// => 2017-05-15</code></pre>
					</section>
					<section>
						<img src="images/traps-traps-everywhere.jpg" alt="traps-traps-everywhere">
					</section>
					<!--fin strtotime-->
				</section>
				<section>
					<section>
						<h1>L'objet <code>DateTime</code></h1>
					</section>
					<section>
						<h2>Enfin on discute !!</h2>
						<h2>Je peux oublier les chapitres précédents !</h2>
					</section>
					<section>
						<h2>Yeah !!</h2>
						<img src="images/yeah-gif.gif" alt="yeah gif">
					</section>
					<section>
						<img src="images/hum-no.png" atl="hum... No !">
						<h2>Hum... NON !!</h2>
						<p>Parce que les comportements sont les mêmes !</p>
					</section>
					<section>
						<pre><code class="php">$firstDayOfThisMonth = new \DateTime('first day of this month');

$firstDayOfThisMonth->format('Y-m-d');

// => 2017-05-01</code></pre>
						<pre class="fragment"><code class="php">$dayFifteenOfThisMonth = new \DateTime();

$dayFifteenOfThisMonth->setTime(0, 0, 0);

$dayFifteenOfThisMonth->setDate(
    (int) $dayFifteenOfThisMonth->format('Y'),
    (int) $dayFifteenOfThisMonth->format('m'),
    15
);

$dayFifteenOfThisMonth->format('Y-m-d');

// => 2017-05-15</code></pre>
						<!--<pre class="fragment"><code class="php"></code></pre>-->
					</section>
					<section>
						<h2>Et les pièges sont les mêmes !</h2>
						<img src="images/its-a-trap.gif" alt="it's a trap !">
					</section>
                    <section>
						<pre><code class="php" >// first Specific day of last Week
// Today is 2017-05-26

$date = new DateTime("First Monday of Last Week");

$date->format('Y-m-d') ;

// => 2017-04-24</code></pre>
<pre class="fragment"><code class="php" >// phrases that seems ok but does not work at all

$wrongDate = new DateTime("Monday of Last Week");

$wrongDate->format('Y-m-d');

// Fatal error: Uncaught Exception: DateTime::__construct():
// Failed to parse time string (Monday of Last Week) </code></pre>
					</section>
					<section>
						<h2><code>DateTimeImmutable</code> c'est quoi ??</h2>
						<p>C'est la même utilisation que <code>DateTime()</code></p>
						<p>La seule différence est que cet objet ne peut pas être modifié une fois créé.</p>
					</section>
					<section>
						<h2>Une fonction en plus : </h2>
							<p><code>DateTimeImmutable::createFromMutable</code></p>
						<pre class="fragment"><code class="php">// create a specific date
$date = new \DateTime();
$date->setTime(0, 0, 0);
$date->setDate(2017, 09, 15);

$myNewDate = \DateTimeImmutable::createFromMutable($date);

echo $myNewDate->format('Y-m-d');
// 2017-09-15</code></pre>

					</section>
				<!--End DateTime Object-->
				</section>
				<section>
					<section>
						<h1>L'objet <code>DateTimeZone</code></h1>
					</section>
					<section>
						<h2>Toujours penser et faire attention avec le fuseau horaire</h2>
						<ul>
							<li>Par défaut configurez le serveur à UTC</li>
							<li>Pensez à sauvegarder celui des dates reçues</li>
							<li>N'oubliez pas de l'appliquer lorsque vous communiquez</li>
						</ul>
					</section>
					<section>
						<pre><code class="php">// set a date with a Timezone

$date = new DateTime('2017-05-01', new DateTimeZone('Europe/Paris'));

echo "Europe/Paris " . $date->format('Y-m-d H:i:sP') . "\n";


$date->setTimezone(new DateTimeZone('Australia/Sydney'));

echo "Australia/Sydney " . $date->format(\DateTime::ISO8601) . "\n";

// Europe/Paris 2017-05-01 00:00:00+02:00
// Australia/Sydney 2017-05-01T08:00:00+1000</code></pre>
					</section>
					<section>
						<h2>Fuseaux Horaires possibles</h2>
						<ul>
							<li>php.net => timezones : Attention à celles qui sont listés dans la catégorie "Autres" comme Japan, Turkey, etc...</li>
							<li>Wikipedia.org => list timezones</li>
						</ul>
					</section>
					<section>
						<pre><code class="php">// set a date with a Timezone in number of hours

$date = new DateTime('2017-05-01', new DateTimeZone('+02:00'));

echo "UTC + 2 hours " . $date->format('Y-m-d H:i:sP') . "\n";

// UTC + 2 hours 2017-05-01 00:00:00+02:00


$utcDate = new DateTime('2017-05-01', new DateTimeZone('UTC'));

echo "UTC date " . $utcDate->format('Y-m-d H:i:sP') . "\n";

// UTC date 2017-05-01 00:00:00+00:00</code></pre>
					</section>
					<section>
						<h2>Et bien sûr... des pièges !</h2>
						<pre><code class="php">// today in Paris, let's try to get the location of the timezone
$dateInParis = new \DateTime('now', new \DateTimeZone('Europe/Paris'));

print_r($dateInParis->getTimezone()->getLocation());
/*Array (
    [country_code] => FR
    [latitude] => 48.86666
    [longitude] => 2.33333
    [comments] =>
)*/</code></pre>
<pre class="fragment"><code class="php">// now if we received this date in string format

$newDateInParis = new \DateTime($dateInParis->format('Y-m-d H:i:sP'));

var_dump($newDateInParis->getTimezone()->getLocation());

// bool(false)</code></pre>
					</section>
				</section>

			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>
		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,
				slideNumber: false,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
